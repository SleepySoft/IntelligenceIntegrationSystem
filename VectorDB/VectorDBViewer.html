<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>向量数据库浏览器</title>
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. 引入 Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <style>
        /* Inter 字体 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        /* 自定义过渡效果 */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        /* 表格中长文本截断 */
        .truncate-text {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- 3. Vue 应用挂载点 -->
    <div id="app" class="min-h-screen p-4 md:p-8">

        <!-- 头部 -->
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900">向量数据库浏览器</h1>

            <!-- 状态指示器 -->
            <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-600">后端状态:</span>
                <span v-if="status.state === 'loading'"
                      class="px-3 py-1 text-sm font-semibold text-yellow-800 bg-yellow-200 rounded-full">
                    正在加载...
                </span>
                <span v-else-if="status.state === 'ready'"
                      class="px-3 py-1 text-sm font-semibold text-green-800 bg-green-200 rounded-full">
                    已就绪
                </span>
                <span v-else
                      class="px-3 py-1 text-sm font-semibold text-red-800 bg-red-200 rounded-full">
                    错误
                </span>
            </div>
        </header>

        <!-- 错误提示条 -->
        <div v-if="status.state === 'error'"
             class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
            <span class="font-medium">连接错误!</span> {{ status.message }}
        </div>

        <!-- 主内容区 (仅在 'ready' 时显示) -->
        <main v-if="status.state === 'ready'" class="space-y-6">

            <!-- 1. Store 选择器 (需求) -->
            <div class="bg-white p-4 shadow-md rounded-lg">
                <label for="store-selector" class="block text-sm font-medium text-gray-700 mb-2">选择要操作的向量数据库:</label>
                <div class="flex flex-wrap -m-2">
                    <button v-for="store in stores" :key="store.name"
                            @click="selectStore(store.name)"
                            :class="[
                                'm-2 px-4 py-2 font-medium rounded-lg transition-all duration-150',
                                selectedStore === store.name
                                    ? 'bg-blue-600 text-white shadow-lg'
                                    : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-300'
                            ]">
                        <span class="font-bold">{{ store.name }}</span>
                        <span class="ml-2 px-2 py-0.5 bg-gray-200 text-gray-800 rounded-full text-xs">{{ store.chunk_count }} chunks</span>
                        <p class="text-xs mt-1 font-normal opacity-90">{{ store.description }}</p>
                    </button>
                </div>
            </div>

            <!-- 2. 功能 Tab (浏览, 搜索, 添加) -->
            <div v-if="selectedStore" class="bg-white shadow-md rounded-lg">
                <!-- Tab 导航 -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button v-for="tab in tabs" :key="tab.id"
                                @click="currentTab = tab.id"
                                :class="[
                                    'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm',
                                    currentTab === tab.id
                                        ? 'border-blue-500 text-blue-600'
                                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                ]">
                            {{ tab.name }}
                        </button>
                    </nav>
                </div>

                <!-- Tab 内容 -->
                <div class="p-4 md:p-6">

                    <!-- (A) 浏览 Tab -->
                    <transition name="fade" mode="out-in">
                        <div v-if="currentTab === 'browse'">
                            <h3 class="text-lg font-semibold mb-4">浏览数据: {{ selectedStore }}</h3>

                            <!-- 加载中 -->
                            <div v-if="browse.loading" class="text-center p-8 text-gray-500">
                                正在加载...
                            </div>

                            <!-- 表格 -->
                            <div v-else-if="browse.data.length > 0" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">文档 UUID</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chunk 索引</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chunk 文本</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr v-for="item in browse.data" :key="item.chunk_id">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ item.metadata.original_doc_id }}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ item.metadata.chunk_index }}</td>
                                            <td class="px-4 py-3 text-sm text-gray-600" :title="item.document">
                                                <span class="truncate-text">{{ item.document }}</span>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                                <button @click="confirmDelete(item.metadata.original_doc_id)"
                                                        class="text-red-600 hover:text-red-900">
                                                    删除 UUID
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div v-else class="text-center p-8 text-gray-500">
                                数据库中没有数据。
                            </div>

                            <!-- 分页 -->
                            <nav class="mt-6 flex items-center justify-between" v-if="browse.data.length > 0">
                                <p class="text-sm text-gray-700">
                                    正在显示 {{ browse.offset + 1 }} 到 {{ browse.offset + browse.data.length }}
                                    (共 {{ browse.total_count }} 条记录)
                                </p>
                                <div class="space-x-2">
                                    <button @click="changePage('prev')"
                                            :disabled="browse.offset === 0"
                                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                        上一页
                                    </button>
                                    <button @click="changePage('next')"
                                            :disabled="browse.offset + browse.limit >= browse.total_count"
                                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                        下一页
                                    </button>
                                </div>
                            </nav>
                        </div>
                    </transition>

                    <!-- (B) 搜索 Tab -->
                    <transition name="fade" mode="out-in">
                        <div v-if="currentTab === 'search'" class="space-y-4">
                            <h3 class="text-lg font-semibold">搜索: {{ selectedStore }}</h3>
                            <div class="flex space-x-2">
                                <input type="text" v-model="search.query" placeholder="输入搜索文本..."
                                       class="flex-grow block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <button @click="handleSearch" :disabled="search.loading"
                                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50">
                                    {{ search.loading ? '搜索中...' : '搜索' }}
                                </button>
                            </div>

                            <!-- 搜索结果 -->
                            <div v-if="search.results.length > 0" class="mt-4 space-y-3">
                                <div v-for="res in search.results" :key="res.chunk_id"
                                     class="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-blue-700">{{ res.doc_id }}</span>
                                        <span class="px-2 py-0.5 text-sm font-bold text-green-800 bg-green-100 rounded-full">
                                            Score: {{ res.score.toFixed(4) }}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600">{{ res.chunk_text }}</p>
                                    <button @click="confirmDelete(res.doc_id)"
                                            class="mt-2 text-xs font-medium text-red-600 hover:text-red-900">
                                        删除 UUID
                                    </button>
                                </div>
                            </div>
                            <div v-if="search.searched && search.results.length === 0" class="text-center p-8 text-gray-500">
                                未找到匹配的结果。
                            </div>
                        </div>
                    </transition>

                    <!-- (C) 添加 Tab -->
                    <transition name="fade" mode="out-in">
                        <div v-if="currentTab === 'add'" class="space-y-4">
                            <h3 class="text-lg font-semibold">添加新文档</h3>
                            <p class="text-sm text-gray-600">
                                (注意: 这将同时在 `intelligence_full_text` 和 `intelligence_summary` 两个库中添加/更新该 UUID 的记录)
                            </p>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">文档 UUID</label>
                                    <input type="text" v-model="addForm.uuid" placeholder="例如: doc-xyz-123"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">
                                        Full Text (用于 `intelligence_full_text`)
                                    </label>
                                    <textarea v-model="addForm.full_text" rows="4" placeholder="粘贴 APPENDIX.RAW_DATA 文本..."
                                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">
                                        Summary Text (用于 `intelligence_summary`)
                                    </label>
                                    <textarea v-model="addForm.summary_text" rows="4" placeholder="粘贴 EVENT_TITLE + BRIEF + TEXT 组合文本..."
                                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                                </div>
                                <button @click="handleAddDocument" :disabled="addForm.loading"
                                        class="px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50">
                                    {{ addForm.loading ? '正在添加...' : '添加/更新文档' }}
                                </button>
                            </div>
                        </div>
                    </transition>

                </div>
            </div>

        </main>

        <!-- (D) 确认删除模态框 (需求: 不使用 confirm()) -->
        <transition name="fade">
            <div v-if="deleteModal.show"
                 class="fixed inset-0 z-10 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <h3 class="text-lg font-medium leading-6 text-gray-900">确认删除</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-600">
                            您确定要删除 UUID 为 <strong>{{ deleteModal.uuid }}</strong> 的文档吗?
                            <br>
                            (此操作将从 <strong>所有</strong> 向量数据库中删除它)
                        </p>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button @click="deleteModal.show = false"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">
                            取消
                        </button>
                        <button @click="executeDelete"
                                class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md shadow-sm hover:bg-red-700">
                            确认删除
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- (E) Toast 通知 -->
        <transition name="fade">
            <div v-if="toast.show"
                 class="fixed bottom-5 right-5 px-4 py-3 rounded-lg shadow-lg"
                 :class="toast.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'">
                {{ toast.message }}
            </div>
        </transition>

    </div>

    <!-- 4. Vue.js 应用脚本 -->
    <script>
        const { createApp, ref, reactive, onMounted, watch } = Vue

        const App = {
            setup() {
                // --- API 配置 ---
                const API_URL = 'http://127.0.0.1:5100/vector/api'; // 后端 API 地址

                // --- 响应式状态 ---
                const status = reactive({ state: 'loading', message: '' });
                const stores = ref([]); // { name, chunk_count, description }
                const selectedStore = ref(null);
                const currentTab = ref('browse'); // 'browse', 'search', 'add'
                const tabs = [
                    { id: 'browse', name: '浏览数据 (Browse)' },
                    { id: 'search', name: '搜索 (Search)' },
                    { id: 'add', name: '添加/更新 (Add/Update)' },
                ];

                const browse = reactive({
                    loading: false,
                    data: [],
                    total_count: 0,
                    limit: 10,
                    offset: 0
                });

                const search = reactive({
                    loading: false,
                    query: '',
                    results: [],
                    searched: false // 是否已执行过搜索
                });

                const addForm = reactive({
                    loading: false,
                    uuid: '',
                    full_text: '',
                    summary_text: ''
                });

                const deleteModal = reactive({
                    show: false,
                    uuid: null
                });

                const toast = reactive({
                    show: false,
                    message: '',
                    type: 'success'
                });

                // --- 通用方法 ---

                const showToast = (message, type = 'success') => {
                    toast.message = message;
                    toast.type = type;
                    toast.show = true;
                    setTimeout(() => { toast.show = false }, 3000);
                };

                // --- API 调用 ---

                // 1. 检查后端状态 (轮询)
                const checkBackendStatus = async () => {
                    try {
                        const res = await fetch(`${API_URL}/status`);
                        const data = await res.json();
                        if (data.status === 'ready') {
                            status.state = 'ready';
                            await fetchStores(); // 准备就绪后，获取 stores
                        } else if (data.status === 'initializing') {
                            status.state = 'loading';
                            setTimeout(checkBackendStatus, 2000); // 2秒后重试
                        } else {
                            status.state = 'error';
                            status.message = data.error || '后端初始化失败';
                        }
                    } catch (err) {
                        status.state = 'error';
                        status.message = `无法连接到后端 (在 ${API_URL})。请确保后端正在运行。`;
                        setTimeout(checkBackendStatus, 5000); // 5秒后重试
                    }
                };

                // 2. 获取 Stores
                const fetchStores = async () => {
                    try {
                        const res = await fetch(`${API_URL}/stores`);
                        stores.value = await res.json();
                        // 默认选择第一个 store
                        if (stores.value.length > 0 && !selectedStore.value) {
                            selectStore(stores.value[0].name);
                        }
                    } catch (err) {
                        showToast('获取 store 列表失败', 'error');
                    }
                };

                // 3. 浏览数据
                const fetchBrowseData = async () => {
                    if (!selectedStore.value) return;
                    browse.loading = true;
                    try {
                        const params = new URLSearchParams({
                            store_name: selectedStore.value,
                            limit: browse.limit,
                            offset: browse.offset
                        });
                        const res = await fetch(`${API_URL}/browse?${params}`);
                        const data = await res.json();
                        if (res.ok) {
                            browse.data = data.data;
                            browse.total_count = data.total_count;
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (err) {
                        showToast(`浏览失败: ${err.message}`, 'error');
                    } finally {
                        browse.loading = false;
                    }
                };

                // 4. 搜索
                const handleSearch = async () => {
                    if (!selectedStore.value || !search.query) return;
                    search.loading = true;
                    search.searched = true;
                    try {
                        const res = await fetch(`${API_URL}/search`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                store_name: selectedStore.value,
                                query_text: search.query,
                                top_n: 5,
                                threshold: 0.5
                            })
                        });
                        const data = await res.json();
                        if (res.ok) {
                            search.results = data;
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (err) {
                        showToast(`搜索失败: ${err.message}`, 'error');
                    } finally {
                        search.loading = false;
                    }
                };

                // 5. 添加
                const handleAddDocument = async () => {
                    if (!addForm.uuid || !addForm.full_text || !addForm.summary_text) {
                        showToast('所有字段均为必填项', 'error');
                        return;
                    }
                    addForm.loading = true;
                    try {
                        const res = await fetch(`${API_URL}/add`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                uuid: addForm.uuid,
                                full_text: addForm.full_text,
                                summary_text: addForm.summary_text
                            })
                        });
                        const data = await res.json();
                        if (res.ok) {
                            showToast(data.message, 'success');
                            // 清空表单
                            addForm.uuid = '';
                            addForm.full_text = '';
                            addForm.summary_text = '';
                            // 刷新 store 计数
                            await fetchStores();
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (err) {
                        showToast(`添加失败: ${err.message}`, 'error');
                    } finally {
                        addForm.loading = false;
                    }
                };

                // 6. 删除
                const confirmDelete = (uuid) => {
                    deleteModal.uuid = uuid;
                    deleteModal.show = true;
                };

                const executeDelete = async () => {
                    const uuid = deleteModal.uuid;
                    deleteModal.show = false;
                    try {
                        const res = await fetch(`${API_URL}/delete`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ uuid: uuid })
                        });
                        const data = await res.json();
                        if (res.ok) {
                            showToast(data.message, 'success');
                            // 刷新数据
                            await fetchStores(); // 更新计数
                            if (currentTab.value === 'browse') {
                                await fetchBrowseData();
                            } else if (currentTab.value === 'search') {
                                // 从搜索结果中移除 (或重新搜索)
                                search.results = search.results.filter(r => r.doc_id !== uuid);
                            }
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (err) {
                        showToast(`删除失败: ${err.message}`, 'error');
                    }
                };


                // --- 事件处理器 ---

                const selectStore = (storeName) => {
                    selectedStore.value = storeName;
                    // 重置所有视图
                    currentTab.value = 'browse';
                    search.query = '';
                    search.results = [];
                    search.searched = false;
                    browse.offset = 0;
                    // 切换 store 时自动加载浏览数据
                    fetchBrowseData();
                };

                const changePage = (direction) => {
                    if (direction === 'next') {
                        browse.offset += browse.limit;
                    } else if (direction === 'prev') {
                        browse.offset = Math.max(0, browse.offset - browse.limit);
                    }
                    fetchBrowseData();
                };

                // --- 监控变化 ---
                // 当 store 改变时，重新获取浏览数据
                // watch(selectedStore, (newStore, oldStore) => {
                //     if (newStore && newStore !== oldStore) {
                //         fetchBrowseData();
                //     }
                // });

                // --- 启动 ---
                onMounted(() => {
                    checkBackendStatus();
                });

                return {
                    status,
                    stores,
                    selectedStore,
                    currentTab,
                    tabs,
                    browse,
                    search,
                    addForm,
                    deleteModal,
                    toast,
                    selectStore,
                    changePage,
                    handleSearch,
                    handleAddDocument,
                    confirmDelete,
                    executeDelete
                };
            }
        };

        createApp(App).mount('#app');
    </script>
</body>
</html>
