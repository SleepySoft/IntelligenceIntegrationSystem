<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CGS Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' }
                    },
                    fontFamily: { mono: ['Menlo', 'Monaco', 'Consolas', 'monospace'] },
                    fontSize: { 'xxs': '0.65rem' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        [x-cloak] { display: none !important; }
        /* Tree Guide Lines */
        .tree-line { position: relative; }
        .tree-line::before {
            content: ''; position: absolute; left: 10px; top: 0; bottom: 0;
            width: 1px; background-color: #374151; opacity: 0.3;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-300 h-screen overflow-hidden flex flex-col font-sans" x-data="dashboard()">

    <header class="bg-gray-900 border-b border-gray-800 h-12 flex items-center px-4 justify-between shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-4">
            <h1 class="font-bold text-lg tracking-wider text-emerald-500">
                CGS <span class="text-gray-500 font-normal text-xs align-middle">Tree View</span>
            </h1>

            <div class="flex bg-gray-800 rounded p-0.5 border border-gray-700 ml-4">
                <button @click="controlSystem('RESUME')"
                        class="px-3 py-0.5 text-xs rounded transition-colors"
                        :class="controlState === 'NORMAL' ? 'bg-emerald-700 text-white shadow' : 'text-gray-400 hover:text-white'">
                    Running
                </button>
                <button @click="controlSystem('PAUSE')"
                        class="px-3 py-0.5 text-xs rounded transition-colors"
                        :class="controlState === 'PAUSE' ? 'bg-yellow-600 text-white shadow' : 'text-gray-400 hover:text-white'">
                    Paused
                </button>
            </div>
            <button @click="controlSystem('IMMEDIATE')"
                    class="text-xs bg-gray-800 hover:bg-blue-600 hover:text-white text-blue-400 px-3 py-1 rounded border border-gray-700 transition">
                ⚡ Pulse
            </button>
        </div>

        <div class="flex gap-4 text-xs">
            <div class="flex items-center gap-2">
                <span class="text-gray-500 uppercase text-[10px]">Active</span>
                <span class="font-mono font-bold text-gray-200" x-text="stats.active_spiders || 0"></span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-gray-500 uppercase text-[10px]">Queue</span>
                <span class="font-mono font-bold text-gray-200" x-text="stats.pending_count || 0"></span>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">

        <aside class="w-[320px] border-r border-gray-800 flex flex-col bg-gray-900/50 flex-shrink-0 select-none">
            <div class="p-2 bg-gray-900 border-b border-gray-800 flex justify-between items-center h-[40px]">
                <h2 class="text-xs font-bold uppercase tracking-wider text-gray-400 pl-2">Explorer</h2>
                <div class="flex gap-1">
                    <button @click="expandAll()" class="text-[10px] text-gray-500 hover:text-white bg-gray-800 px-1.5 rounded" title="Expand All">+</button>
                    <button @click="collapseAll()" class="text-[10px] text-gray-500 hover:text-white bg-gray-800 px-1.5 rounded" title="Collapse All">-</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto py-2">
                <template x-for="node in visibleTreeNodes" :key="node.path">

                    <div class="group flex items-center cursor-pointer hover:bg-gray-800/80 min-h-[28px] pr-2 transition-colors relative"
                         :class="{
                             'bg-gray-800 border-r-2 border-emerald-500': selectedGroup === node.path,
                             'text-gray-400': !node.isRealGroup,
                             'text-gray-200': node.isRealGroup
                         }"
                         :style="`padding-left: ${node.level * 16 + 8}px`"
                         @click="handleNodeClick(node)">

                        <div class="w-4 h-4 flex items-center justify-center mr-1 text-gray-500 hover:text-white shrink-0"
                             @click.stop="toggleNode(node.path)">
                            <span x-show="node.hasChildren && !isCollapsed(node.path)" class="text-[8px]">▼</span>
                            <span x-show="node.hasChildren && isCollapsed(node.path)" class="text-[8px]">▶</span>
                            <span x-show="!node.hasChildren" class="text-[8px] opacity-30">•</span>
                        </div>

                        <div class="mr-2 shrink-0">
                            <svg x-show="!node.isRealGroup" class="w-3.5 h-3.5 text-blue-400/50" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg>
                            <svg x-show="node.isRealGroup && isGroupHealthy(node.data)" class="w-3.5 h-3.5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <svg x-show="node.isRealGroup && !isGroupHealthy(node.data)" class="w-3.5 h-3.5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>

                        <span class="text-xs truncate flex-1" x-text="node.name"></span>

                        <div x-show="node.isRealGroup" class="flex gap-1.5 text-[9px] font-mono ml-2 text-gray-500">
                            <span x-show="node.data.stats.running > 0" class="text-blue-400" x-text="'R:'+node.data.stats.running"></span>
                            <span x-show="node.data.stats.failed > 0" class="text-red-400" x-text="'E:'+node.data.stats.failed"></span>
                        </div>
                    </div>
                </template>
            </div>
        </aside>

        <section class="flex-1 flex flex-col bg-gray-950 min-w-0">

            <div class="bg-gray-900 border-b border-gray-700 shadow-md shrink-0 transition-all duration-300"
                 x-show="currentGroupData"
                 x-transition:enter="ease-out duration-200"
                 x-transition:enter-start="opacity-0 -translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0">

                <div class="px-4 py-2 flex justify-between items-center border-b border-gray-800 bg-gray-850">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500 text-xs">Path:</span>
                        <div class="flex items-center text-sm font-mono text-gray-300">
                            <span x-text="currentGroupData?.group_path.replace(/\//g, ' / ')"></span>
                        </div>
                    </div>
                    <button @click="selectedGroup = null; currentGroupData = null" class="text-xs text-gray-500 hover:text-white px-2 py-1 rounded hover:bg-gray-700">✕ Close</button>
                </div>

                <div class="p-4 flex items-start gap-4">
                    <div class="flex-1 bg-gray-800/50 border border-gray-700 rounded p-3 flex gap-3">
                        <div class="shrink-0 pt-1">
                            <div class="w-3 h-3 rounded-full animate-pulse"
                                 :class="getAnchorColorClass(anchorStatus?.status)"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-gray-400 uppercase">Anchor List URL</span>
                                <span class="text-[10px] font-mono px-1 rounded"
                                      :class="anchorStatus?.http_code >= 400 ? 'bg-red-900 text-red-200' : 'bg-gray-700 text-gray-300'"
                                      x-text="anchorStatus?.http_code ? 'HTTP ' + anchorStatus.http_code : 'NO DATA'"></span>
                            </div>
                            <div class="text-sm font-mono text-white truncate"
                                 x-text="anchorStatus?.url || 'No List URL Configured'"></div>

                            <div class="mt-2 flex gap-4 text-xs text-gray-500">
                                <span>Last: <span class="text-gray-300" x-text="formatTimeAgo(anchorStatus?.last_run_at)"></span></span>
                                <span>Next: <span class="text-blue-300" x-text="formatNextRun(anchorStatus?.next_run_at)"></span></span>
                            </div>
                        </div>
                    </div>

                    <div class="w-48 shrink-0 bg-gray-800/50 border border-gray-700 rounded p-3">
                        <div class="text-[10px] font-bold text-gray-500 uppercase mb-2">Group Activity</div>
                        <div class="grid grid-cols-2 gap-y-2 text-xs">
                            <div>
                                <div class="text-gray-500 text-[10px]">Total</div>
                                <div class="font-mono text-white" x-text="currentGroupData?.stats.total || 0"></div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-[10px]">Success</div>
                                <div class="font-mono text-emerald-400" x-text="currentGroupData?.stats.success || 0"></div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-[10px]">Running</div>
                                <div class="font-mono text-blue-400" x-text="currentGroupData?.stats.running || 0"></div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-[10px]">Errors</div>
                                <div class="font-mono text-red-400" x-text="currentGroupData?.stats.failed || 0"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-4 py-1.5 bg-gray-900 border-b border-gray-800 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Logs</span>
                    <span class="text-xxs px-1.5 py-0.5 rounded-full bg-gray-800 text-gray-400" x-text="logs.length"></span>
                </div>
                <div class="flex bg-gray-800 rounded p-0.5">
                    <button @click="logFilter = 'ALL'" :class="logFilter === 'ALL' ? 'bg-gray-600 text-white shadow' : 'text-gray-500 hover:text-gray-300'" class="text-xxs px-2 py-0.5 rounded transition">All</button>
                    <button @click="logFilter = 2" :class="logFilter === 2 ? 'bg-emerald-800 text-emerald-100 shadow' : 'text-gray-500 hover:text-emerald-400'" class="text-xxs px-2 py-0.5 rounded transition">OK</button>
                    <button @click="logFilter = 3" :class="logFilter === 3 ? 'bg-red-800 text-red-100 shadow' : 'text-gray-500 hover:text-red-400'" class="text-xxs px-2 py-0.5 rounded transition">Err</button>
                </div>
            </div>

            <div class="flex-1 flex flex-col min-h-0">
                <div class="grid grid-cols-12 gap-2 px-4 py-2 bg-gray-900/50 border-b border-gray-800 text-xxs font-bold text-gray-500 uppercase tracking-wide shrink-0">
                    <div class="col-span-1">Time</div>
                    <div class="col-span-1">Stat</div>
                    <div class="col-span-7">URL / Path</div>
                    <div class="col-span-1">Code</div>
                    <div class="col-span-1 text-right">Dur.</div>
                    <div class="col-span-1 text-right">View</div>
                </div>

                <div class="flex-1 overflow-y-auto overflow-x-hidden">
                    <template x-for="log in logs" :key="log.id">
                        <div class="grid grid-cols-12 gap-2 px-4 py-1 border-b border-gray-800/30 text-xs font-mono items-center hover:bg-gray-800/40 transition-colors group">

                            <div class="col-span-1 text-gray-600 text-[10px]" x-text="formatTimeOnly(log.created_at)"></div>

                            <div class="col-span-1">
                                <span class="w-1.5 h-1.5 rounded-full inline-block mr-1"
                                      :class="{
                                          'bg-blue-500': log.status === 1,
                                          'bg-emerald-500': log.status === 2,
                                          'bg-yellow-500': log.status === 3,
                                          'bg-red-500': log.status === 4
                                      }"></span>
                                <span class="text-[10px] text-gray-400" x-text="getStatusLabel(log.status)"></span>
                            </div>

                            <div class="col-span-7 overflow-hidden">
                                <div class="truncate text-gray-300 group-hover:text-white cursor-pointer" :title="log.url" x-text="log.url"></div>
                                <div x-show="!selectedGroup" class="truncate text-[9px] text-gray-600" x-text="log.group_path"></div>
                            </div>

                            <div class="col-span-1" :class="log.http_code >= 400 ? 'text-red-400' : 'text-emerald-600'" x-text="log.http_code || '-'"></div>

                            <div class="col-span-1 text-right text-gray-600 text-[10px]" x-text="log.duration ? log.duration + 's' : '-'"></div>

                            <div class="col-span-1 text-right">
                                <button @click="viewSnapshot(log)" x-show="log.status === 2" class="opacity-0 group-hover:opacity-100 text-blue-500 hover:text-blue-300 text-[10px]">VIEW</button>
                            </div>
                        </div>
                    </template>
                    <div x-show="logs.length === 0" class="p-8 text-center text-gray-700 text-xs italic">
                        No logs found matching filters.
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div x-show="modalOpen" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm" @click.self="modalOpen = false">
        <div class="bg-gray-900 w-[95%] h-[90%] rounded border border-gray-700 flex flex-col">
            <div class="h-10 flex justify-between items-center px-4 bg-gray-800 border-b border-gray-700">
                <span class="text-xs text-gray-300 font-mono" x-text="previewUrl"></span>
                <button @click="modalOpen = false" class="text-white hover:text-gray-400">✕</button>
            </div>
            <iframe :src="previewUrl" class="flex-1 bg-white border-none"></iframe>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                stats: {},
                rawGroups: [], // Data from API
                logs: [],

                // Tree State
                collapsedPaths: new Set(), // Set of paths that are closed
                treeNodes: [], // Calculated flat list for rendering

                // Selection
                selectedGroup: null,
                currentGroupData: null,

                // Filters
                logFilter: 'ALL',
                controlState: 'NORMAL',
                modalOpen: false,
                previewUrl: '',

                init() {
                    this.refreshData();
                    setInterval(() => this.refreshData(), 3000);
                },

                async refreshData() {
                    try {
                        const [sRes, gRes] = await Promise.all([
                            fetch('/api/dashboard/stats'),
                            fetch('/api/groups')
                        ]);
                        this.stats = await sRes.json();
                        this.rawGroups = await gRes.json();

                        // Rebuild Tree Nodes Structure
                        this.rebuildTree();

                        // Update Current Group Data Reference
                        if (this.selectedGroup) {
                            this.currentGroupData = this.rawGroups.find(g => g.group_path === this.selectedGroup);
                        }

                        // Fetch Logs
                        let logQuery = '/api/logs?limit=100';
                        if (this.selectedGroup) {
                            // Filter by spider for backend performance, then refine client side
                            const spider = this.selectedGroup.split('/')[0];
                            logQuery += `&spider=${encodeURIComponent(spider)}`;
                        }
                        if (this.logFilter !== 'ALL') logQuery += `&status=${this.logFilter}`;

                        const lRes = await fetch(logQuery);
                        let rawLogs = await lRes.json();

                        // Precise filtering
                        if (this.selectedGroup) {
                            rawLogs = rawLogs.filter(l => l.group_path === this.selectedGroup);
                        }
                        this.logs = rawLogs;

                    } catch (e) { console.error(e); }
                },

                // --- Tree Logic (The Core Magic) ---

                rebuildTree() {
                    // 1. Collect all unique paths (including intermediate folders)
                    const pathMap = new Map();

                    this.rawGroups.forEach(g => {
                        const parts = g.group_path.split('/');
                        let currentPath = '';

                        parts.forEach((part, index) => {
                            currentPath = currentPath ? `${currentPath}/${part}` : part;

                            if (!pathMap.has(currentPath)) {
                                pathMap.set(currentPath, {
                                    path: currentPath,
                                    name: part,
                                    level: index,
                                    isRealGroup: false, // Default to folder
                                    data: null,
                                    hasChildren: false
                                });
                            }
                            // If this is the full path of the group, attach data
                            if (index === parts.length - 1) {
                                const node = pathMap.get(currentPath);
                                node.isRealGroup = true;
                                node.data = g;
                            }
                            // Mark parent as having children
                            if (index > 0) {
                                const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                                if (pathMap.has(parentPath)) {
                                    pathMap.get(parentPath).hasChildren = true;
                                }
                            }
                        });
                    });

                    // 2. Convert to array and sort
                    let nodes = Array.from(pathMap.values()).sort((a, b) => a.path.localeCompare(b.path));
                    this.treeNodes = nodes;
                },

                get visibleTreeNodes() {
                    // Filter out nodes whose parents are collapsed
                    return this.treeNodes.filter(node => {
                        const parts = node.path.split('/');
                        // Check all possible parent paths
                        // e.g. for "a/b/c", check "a" and "a/b"
                        let checkPath = '';
                        for (let i = 0; i < parts.length - 1; i++) {
                            checkPath = checkPath ? `${checkPath}/${parts[i]}` : parts[i];
                            if (this.collapsedPaths.has(checkPath)) {
                                return false; // Hidden
                            }
                        }
                        return true;
                    });
                },

                isCollapsed(path) {
                    return this.collapsedPaths.has(path);
                },

                toggleNode(path) {
                    if (this.collapsedPaths.has(path)) {
                        this.collapsedPaths.delete(path);
                    } else {
                        this.collapsedPaths.add(path);
                    }
                },

                expandAll() { this.collapsedPaths.clear(); },
                collapseAll() {
                    this.treeNodes.forEach(n => {
                        if (n.hasChildren) this.collapsedPaths.add(n.path);
                    });
                },

                handleNodeClick(node) {
                    // 1. If it has children, toggle it (Folder behavior)
                    // if (node.hasChildren) {
                    //     this.toggleNode(node.path);
                    // }
                    // User preference: Click name = Select? Or Click name = Toggle?
                    // Let's do: Click Arrow = Toggle, Click Row = Select (if real group)

                    if (node.isRealGroup) {
                        this.selectedGroup = node.path;
                        this.currentGroupData = node.data;
                        this.refreshData();
                    } else {
                        // If it's just a folder, toggle it
                        this.toggleNode(node.path);
                    }
                },

                // --- Helpers ---

                isGroupHealthy(group) {
                    if (!group || !group.list_url_status) return true; // Assume ok if no anchor
                    const s = group.list_url_status.status;
                    return s !== 3 && s !== 4; // Not Fail
                },

                get anchorStatus() { return this.currentGroupData?.list_url_status; },

                getAnchorColorClass(status) {
                    if (status === 1) return 'bg-blue-500';
                    if (status === 2) return 'bg-emerald-500';
                    if (status === 3 || status === 4) return 'bg-red-500';
                    return 'bg-gray-600';
                },

                async controlSystem(action) {
                    await fetch(`/api/control/${action}`, {method: 'POST'});
                    if(action !== 'IMMEDIATE') this.controlState = (action === 'RESUME' ? 'NORMAL' : 'PAUSE');
                },

                getStatusLabel(s) { return {0:'PEND',1:'RUN',2:'OK',3:'RETRY',4:'FAIL',5:'SKIP'}[s] || s; },
                formatTimeOnly(iso) { return iso ? iso.split('T')[1].split('.')[0] : ''; },

                formatTimeAgo(iso) {
                    if (!iso) return '-';
                    const s = (new Date() - new Date(iso)) / 1000;
                    if (s < 60) return Math.floor(s) + 's ago';
                    if (s < 3600) return Math.floor(s/60) + 'm ago';
                    return Math.floor(s/3600) + 'h ago';
                },
                formatNextRun(iso) {
                    if (!iso) return '-';
                    const diff = (new Date(iso) - new Date()) / 1000;
                    return diff < 0 ? 'Now' : Math.floor(diff) + 's';
                },
                viewSnapshot(log) { alert("Hash required"); }
            }
        }
    </script>
</body>
</html>
