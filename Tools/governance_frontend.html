<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CGS Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' }
                    },
                    fontFamily: { mono: ['Menlo', 'Monaco', 'Consolas', 'monospace'] },
                    fontSize: { 'xxs': '0.65rem' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        [x-cloak] { display: none !important; }
        /* Tree Guide Lines */
        .tree-line { position: relative; }
        .tree-line::before {
            content: ''; position: absolute; left: 10px; top: 0; bottom: 0;
            width: 1px; background-color: #374151; opacity: 0.3;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-300 h-screen overflow-hidden flex flex-col font-sans" x-data="dashboard()">

    <header class="bg-gray-900 border-b border-gray-800 h-12 flex items-center px-4 justify-between shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-4">
            <h1 class="font-bold text-lg tracking-wider text-emerald-500">
                CGS <span class="text-gray-500 font-normal text-xs align-middle">Tree View</span>
            </h1>

            <div class="flex bg-gray-800 rounded p-0.5 border border-gray-700 ml-4">
                <button @click="controlSystem('RESUME')"
                        class="px-3 py-0.5 text-xs rounded transition-colors"
                        :class="controlState === 'NORMAL' ? 'bg-emerald-700 text-white shadow' : 'text-gray-400 hover:text-white'">
                    Running
                </button>
                <button @click="controlSystem('PAUSE')"
                        class="px-3 py-0.5 text-xs rounded transition-colors"
                        :class="controlState === 'PAUSE' ? 'bg-yellow-600 text-white shadow' : 'text-gray-400 hover:text-white'">
                    Paused
                </button>
            </div>
            <button @click="controlSystem('IMMEDIATE')"
                    class="text-xs bg-gray-800 hover:bg-blue-600 hover:text-white text-blue-400 px-3 py-1 rounded border border-gray-700 transition">
                ⚡ Pulse
            </button>
        </div>

        <div class="flex gap-4 text-xs">
            <div class="flex items-center gap-2">
                <span class="text-gray-500 uppercase text-[10px]">Active</span>
                <span class="font-mono font-bold text-gray-200" x-text="stats.active_spiders || 0"></span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-gray-500 uppercase text-[10px]">Queue</span>
                <span class="font-mono font-bold text-gray-200" x-text="stats.pending_count || 0"></span>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">

        <aside class="w-[340px] border-r border-gray-800 flex flex-col bg-gray-900/50 flex-shrink-0 select-none">
            <div class="p-2 bg-gray-900 border-b border-gray-800 flex justify-between items-center h-[40px]">
                <h2 class="text-xs font-bold uppercase tracking-wider text-gray-400 pl-2">Explorer</h2>
                <div class="flex gap-1">
                    <button @click="expandAll()" class="text-[10px] text-gray-500 hover:text-white bg-gray-800 px-1.5 rounded" title="Expand All">+</button>
                    <button @click="collapseAll()" class="text-[10px] text-gray-500 hover:text-white bg-gray-800 px-1.5 rounded" title="Collapse All">-</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto py-2 custom-scrollbar">
                <template x-for="node in visibleTreeNodes" :key="node.path">

                    <div class="group flex items-center justify-between cursor-pointer hover:bg-gray-800/80 min-h-[28px] pr-2 transition-colors relative"
                         :class="{
                             'bg-gray-800 border-r-2 border-emerald-500': selectedGroup === node.path,
                             'text-gray-400': !node.isRealGroup,
                             'text-gray-200': node.isRealGroup
                         }"
                         @click="handleNodeClick(node)">

                        <div class="flex items-center flex-1 min-w-0" :style="`padding-left: ${node.level * 16 + 8}px`">

                            <div class="w-4 h-4 flex items-center justify-center mr-1 text-gray-500 hover:text-white shrink-0"
                                 @click.stop="toggleNode(node.path)">
                                <span x-show="node.hasChildren && !isCollapsed(node.path)" class="text-[8px]">▼</span>
                                <span x-show="node.hasChildren && isCollapsed(node.path)" class="text-[8px]">▶</span>
                                <span x-show="!node.hasChildren" class="text-[8px] opacity-20">•</span>
                            </div>

                            <div class="mr-2 shrink-0">
                                <svg x-show="!node.isRealGroup" class="w-3.5 h-3.5 text-blue-400/40" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg>
                                <svg x-show="node.isRealGroup && isGroupHealthy(node.data)" class="w-3.5 h-3.5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <svg x-show="node.isRealGroup && !isGroupHealthy(node.data)" class="w-3.5 h-3.5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>

                            <span class="text-xs truncate" x-text="node.name" :title="node.name"></span>
                        </div>

                        <div x-show="node.isRealGroup" class="flex items-center ml-2 shrink-0">
                            <div class="flex text-[9px] font-mono border border-gray-700/50 rounded overflow-hidden">
                                <div class="px-1.5 py-0.5 text-black font-bold"
                                     :class="getRateColor(node.data.stats)">
                                    <span x-text="calculateRate(node.data.stats)"></span>
                                </div>
                                <div class="px-1.5 py-0.5 bg-gray-700 text-gray-300 min-w-[24px] text-center">
                                    <span x-text="node.data.stats.total || 0"></span>
                                </div>
                            </div>
                        </div>

                    </div>
                </template>
            </div>
        </aside>

        <section class="flex-1 flex flex-col bg-gray-950 min-w-0">
            <div class="bg-gray-900 border-b border-gray-700 shadow-md shrink-0 transition-all duration-300"
                 x-show="currentGroupData"
                 x-transition:enter="ease-out duration-200"
                 x-transition:enter-start="opacity-0 -translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 style="display: none;">

                <div class="px-4 py-2 flex justify-between items-center border-b border-gray-800 bg-gray-850">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500 text-xs">Path:</span>
                        <div class="flex items-center text-sm font-mono text-gray-300">
                            <span x-text="currentGroupData?.group_path.replace(/\//g, ' / ')"></span>
                        </div>
                    </div>
                    <button @click="selectedGroup = null; currentGroupData = null; refreshData()" class="text-xs text-gray-500 hover:text-white px-2 py-1 rounded hover:bg-gray-700">✕ Close Group</button>
                </div>

                <div class="p-4 flex items-start gap-4">
                    <div class="flex-1 bg-gray-800/50 border border-gray-700 rounded p-3 flex gap-3">
                        <div class="shrink-0 pt-1">
                            <div class="w-3 h-3 rounded-full shadow-[0_0_10px_rgba(0,0,0,0.5)]"
                                 :class="getAnchorColorClass(anchorStatus?.status)"
                                 :class="anchorStatus?.status === 1 ? 'animate-pulse' : ''"></div>
                        </div>

                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Anchor List URL</span>
                                <span class="text-[10px] font-mono px-1.5 py-0.5 rounded border"
                                      :class="anchorStatus?.http_code >= 400 ? 'bg-red-900/30 text-red-300 border-red-800' : (anchorStatus?.http_code ? 'bg-emerald-900/30 text-emerald-300 border-emerald-800' : 'bg-gray-700 text-gray-400 border-gray-600')"
                                      x-text="anchorStatus?.http_code ? 'HTTP ' + anchorStatus.http_code : 'NO DATA'"></span>
                            </div>

                            <div class="text-sm font-mono text-white truncate mb-2"
                                 :title="anchorStatus?.url"
                                 x-text="anchorStatus?.url || 'No List URL Configured'"></div>

                            <div class="flex gap-6 text-xs text-gray-500 font-mono border-t border-gray-700/50 pt-2">
                                <div class="flex gap-2">
                                    <span>Last Check:</span>
                                    <span class="text-gray-300" x-text="formatTimeAgo(anchorStatus?.last_run_at)"></span>
                                </div>
                                <div class="flex gap-2">
                                    <span>Next Run:</span>
                                    <span class="text-blue-300" x-text="formatNextRun(anchorStatus?.next_run_at)"></span>
                                </div>
                            </div>

                            <div x-show="anchorStatus?.state_msg && anchorStatus.status > 2"
                                 class="mt-2 text-xs text-red-400 bg-red-900/10 p-1 rounded border border-red-900/30"
                                 x-text="anchorStatus?.state_msg"></div>
                        </div>
                    </div>

                    <div class="w-48 shrink-0 bg-gray-800/50 border border-gray-700 rounded p-3 flex flex-col justify-center">
                        <div class="text-[10px] font-bold text-gray-500 uppercase mb-3 border-b border-gray-700 pb-1">Group Activity</div>
                        <div class="grid grid-cols-2 gap-y-3 text-xs">
                            <div>
                                <div class="text-gray-500 text-[9px] uppercase">Total</div>
                                <div class="font-mono text-white text-sm" x-text="currentGroupData?.stats.total || 0"></div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-[9px] uppercase">Success</div>
                                <div class="font-mono text-emerald-400 text-sm" x-text="currentGroupData?.stats.success || 0"></div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-[9px] uppercase">Running</div>
                                <div class="font-mono text-blue-400 text-sm" x-text="currentGroupData?.stats.running || 0"></div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-[9px] uppercase">Errors</div>
                                <div class="font-mono text-red-400 text-sm" x-text="currentGroupData?.stats.failed || 0"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-4 py-2 bg-gray-900 border-b border-gray-800 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-4">
                    <div class="flex bg-gray-950 p-1 rounded border border-gray-700">
                        <button @click="viewMode = 'LATEST'; refreshData()"
                                class="px-3 py-1 text-xs rounded transition-all flex items-center gap-2 border border-transparent"
                                :class="viewMode === 'LATEST' ? 'bg-gray-800 text-emerald-400 border-gray-600 shadow-sm font-bold' : 'text-gray-500 hover:text-gray-300'">
                            <span>◎ Latest State</span>
                        </button>
                        <button @click="viewMode = 'HISTORY'; refreshData()"
                                class="px-3 py-1 text-xs rounded transition-all flex items-center gap-2 border border-transparent"
                                :class="viewMode === 'HISTORY' ? 'bg-gray-800 text-blue-400 border-gray-600 shadow-sm font-bold' : 'text-gray-500 hover:text-gray-300'">
                            <span>≣ Log History</span>
                        </button>
                    </div>

                    <span class="text-xxs text-gray-500 border-l border-gray-800 pl-4 uppercase tracking-wide" x-show="viewMode === 'LATEST'">
                        Live Snapshot (De-duplicated)
                    </span>
                    <span class="text-xxs text-gray-500 border-l border-gray-800 pl-4 uppercase tracking-wide" x-show="viewMode === 'HISTORY'">
                        Historical Event Stream
                    </span>
                </div>

                <div class="flex gap-1 bg-gray-950 rounded p-1 border border-gray-700">
                    <button @click="logFilter = 'ALL'; refreshData()" :class="logFilter === 'ALL' ? 'bg-gray-700 text-white' : 'text-gray-500 hover:text-gray-300'" class="text-xxs px-2 py-0.5 rounded transition">All</button>
                    <button @click="logFilter = 2; refreshData()" :class="logFilter === 2 ? 'bg-emerald-900/50 text-emerald-200' : 'text-gray-500 hover:text-emerald-400'" class="text-xxs px-2 py-0.5 rounded transition">OK</button>
                    <button @click="logFilter = 3; refreshData()" :class="logFilter === 3 ? 'bg-red-900/50 text-red-200' : 'text-gray-500 hover:text-red-400'" class="text-xxs px-2 py-0.5 rounded transition">Err</button>
                </div>
            </div>

            <div class="flex-1 flex flex-col min-h-0 bg-gray-950">
                <div class="grid grid-cols-12 gap-2 px-4 py-2 bg-gray-900/50 border-b border-gray-800 text-xxs font-bold text-gray-500 uppercase tracking-wide shrink-0">
                    <div class="col-span-1 text-center">#</div>
                    <div class="col-span-2">Time</div>
                    <div class="col-span-1">Status</div>
                    <div class="col-span-6">URL / Info</div>
                    <div class="col-span-1">Code</div>
                    <div class="col-span-1 text-right">Dur/Snap</div>
                </div>

                <div class="flex-1 overflow-y-auto overflow-x-hidden" id="mainList">
                    <template x-for="(row, index) in listData" :key="row.id_key">
                        <div class="grid grid-cols-12 gap-2 px-4 py-1.5 border-b border-gray-800/30 text-xs font-mono items-center hover:bg-gray-800/40 transition-colors group">

                            <div class="col-span-1 text-center text-gray-600 text-[10px]" x-text="index + 1"></div>

                            <div class="col-span-2 text-gray-500 text-[10px] truncate"
                                 :title="formatFullDate(row.display_time)"
                                 x-text="formatTimeOnly(row.display_time)"></div>

                            <div class="col-span-1">
                                <span class="px-1.5 py-0.5 rounded-[2px] text-[10px] font-bold border inline-block w-12 text-center"
                                      :class="{
                                          'bg-blue-900/20 text-blue-400 border-blue-900/50': row.status === 1,
                                          'bg-emerald-900/20 text-emerald-400 border-emerald-900/50': row.status === 2,
                                          'bg-yellow-900/20 text-yellow-400 border-yellow-900/50': row.status === 3,
                                          'bg-red-900/20 text-red-400 border-red-900/50': row.status === 4,
                                          'bg-gray-800 text-gray-500 border-gray-700': row.status === 0 || row.status === 5
                                      }"
                                      x-text="getStatusLabel(row.status)">
                                </span>
                            </div>

                            <div class="col-span-6 overflow-hidden">
                                <div class="flex items-center gap-2">
                                    <div class="truncate text-gray-300 group-hover:text-white cursor-pointer flex-1" :title="row.url" x-text="row.url"></div>

                                    <span x-show="viewMode === 'LATEST' && row.retry_count > 0"
                                          class="text-[9px] bg-yellow-900/30 text-yellow-500 border border-yellow-900/50 px-1 rounded flex items-center gap-1 shrink-0">
                                          <span>↺</span> <span x-text="row.retry_count"></span>
                                    </span>
                                </div>
                                <div x-show="!selectedGroup" class="truncate text-[9px] text-gray-600" x-text="row.group_path"></div>
                            </div>

                            <div class="col-span-1"
                                 :class="row.http_code >= 400 ? 'text-red-400 font-bold' : (row.http_code ? 'text-emerald-600' : 'text-gray-700')"
                                 x-text="row.http_code || '-'"></div>

                            <div class="col-span-1 text-right flex justify-end items-center gap-2">
                                <span class="text-gray-600 text-[10px]" x-text="row.duration ? row.duration + 's' : ''"></span>
                                <button @click="viewSnapshot(row)" x-show="row.status === 2" class="opacity-0 group-hover:opacity-100 text-blue-500 hover:text-blue-300 text-[10px] hover:underline bg-gray-800 px-1 rounded border border-gray-700">SNAP</button>
                            </div>
                        </div>
                    </template>

                    <div x-show="listData.length === 0" class="p-8 text-center text-gray-700 text-xs italic">
                        No records found for this view.
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div x-show="modalOpen" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm" @click.self="modalOpen = false">
        <div class="bg-gray-900 w-[95%] h-[90%] rounded border border-gray-700 flex flex-col">
            <div class="h-10 flex justify-between items-center px-4 bg-gray-800 border-b border-gray-700">
                <span class="text-xs text-gray-300 font-mono" x-text="previewUrl"></span>
                <button @click="modalOpen = false" class="text-white hover:text-gray-400">✕</button>
            </div>
            <iframe :src="previewUrl" class="flex-1 bg-white border-none"></iframe>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                stats: {},
                rawGroups: [],
                listData: [], // Unified data holder for both views

                // View State
                viewMode: 'LATEST', // 'LATEST' (Status) or 'HISTORY' (Log)

                // Other state...
                collapsedPaths: new Set(),
                treeNodes: [],
                selectedGroup: null,
                currentGroupData: null,
                logFilter: 'ALL',
                controlState: 'NORMAL',
                modalOpen: false,
                previewUrl: '',

                init() {
                    this.refreshData();
                    setInterval(() => this.refreshData(), 3000);
                },

                async refreshData() {
                    try {
                        const [sRes, gRes] = await Promise.all([
                            fetch('/api/dashboard/stats'),
                            fetch('/api/groups')
                        ]);
                        this.stats = await sRes.json();
                        this.rawGroups = await gRes.json();
                        this.rebuildTree();

                        if (this.selectedGroup) {
                            this.currentGroupData = this.rawGroups.find(g => g.group_path === this.selectedGroup);
                        }

                        // --- FETCH LIST DATA BASED ON MODE ---
                        let endpoint = '';
                        if (this.viewMode === 'LATEST') {
                            endpoint = '/api/status/recent'; // Call the NEW backend API
                        } else {
                            endpoint = '/api/logs'; // Call the OLD backend API
                        }

                        let query = `${endpoint}?limit=100`;

                        // Filters
                        if (this.selectedGroup) {
                            const spider = this.selectedGroup.split('/')[0];
                            query += `&spider=${encodeURIComponent(spider)}`;
                        }
                        if (this.logFilter !== 'ALL') {
                            query += `&status=${this.logFilter}`;
                        }

                        const res = await fetch(query);
                        let rawRows = await res.json();

                        // Client-side precise filtering
                        if (this.selectedGroup) {
                            rawRows = rawRows.filter(r => r.group_path === this.selectedGroup);
                        }

                        // --- NORMALIZE DATA ---
                        // Logs use 'created_at', Status uses 'last_run_at'
                        // We map them to common fields for the template
                        this.listData = rawRows.map(r => ({
                            ...r,
                            id_key: this.viewMode === 'LATEST' ? r.url : r.id, // Unique key for Alpine
                            display_time: this.viewMode === 'LATEST' ? r.last_run_at : r.created_at,
                            // Ensure retry_count exists (Logs might not have it, default to 0)
                            retry_count: r.retry_count || 0
                        }));

                    } catch (e) { console.error(e); }
                },

                // --- Tree Logic (The Core Magic) ---

                calculateRate(stats) {
                    if (!stats || !stats.total) return '0%';
                    const rate = Math.round((stats.success / stats.total) * 100);
                    return rate + '%';
                },

                getRateColor(stats) {
                    if (!stats || !stats.total) return 'bg-gray-500 text-white';
                    const rate = (stats.success / stats.total);
                    if (rate >= 0.9) return 'bg-emerald-500 text-black'; // High success
                    if (rate >= 0.5) return 'bg-yellow-500 text-black'; // Med success
                    return 'bg-red-500 text-white'; // Low success
                },

                // --- Time Formatters ---
                formatTimeOnly(iso) {
                    if(!iso) return '-';
                    // Returns HH:MM:SS
                    try {
                        const d = new Date(iso);
                        return d.toLocaleTimeString([], { hour12: false });
                    } catch(e) { return iso; }
                },

                formatFullDate(iso) {
                    if(!iso) return '';
                    return new Date(iso).toLocaleString();
                },

                rebuildTree() {
                    // 1. Collect all unique paths (including intermediate folders)
                    const pathMap = new Map();

                    this.rawGroups.forEach(g => {
                        const parts = g.group_path.split('/');
                        let currentPath = '';

                        parts.forEach((part, index) => {
                            currentPath = currentPath ? `${currentPath}/${part}` : part;

                            if (!pathMap.has(currentPath)) {
                                pathMap.set(currentPath, {
                                    path: currentPath,
                                    name: part,
                                    level: index,
                                    isRealGroup: false, // Default to folder
                                    data: null,
                                    hasChildren: false
                                });
                            }
                            // If this is the full path of the group, attach data
                            if (index === parts.length - 1) {
                                const node = pathMap.get(currentPath);
                                node.isRealGroup = true;
                                node.data = g;
                            }
                            // Mark parent as having children
                            if (index > 0) {
                                const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                                if (pathMap.has(parentPath)) {
                                    pathMap.get(parentPath).hasChildren = true;
                                }
                            }
                        });
                    });

                    // 2. Convert to array and sort
                    let nodes = Array.from(pathMap.values()).sort((a, b) => a.path.localeCompare(b.path));
                    this.treeNodes = nodes;
                },

                get visibleTreeNodes() {
                    // Filter out nodes whose parents are collapsed
                    return this.treeNodes.filter(node => {
                        const parts = node.path.split('/');
                        // Check all possible parent paths
                        // e.g. for "a/b/c", check "a" and "a/b"
                        let checkPath = '';
                        for (let i = 0; i < parts.length - 1; i++) {
                            checkPath = checkPath ? `${checkPath}/${parts[i]}` : parts[i];
                            if (this.collapsedPaths.has(checkPath)) {
                                return false; // Hidden
                            }
                        }
                        return true;
                    });
                },

                isCollapsed(path) {
                    return this.collapsedPaths.has(path);
                },

                toggleNode(path) {
                    if (this.collapsedPaths.has(path)) {
                        this.collapsedPaths.delete(path);
                    } else {
                        this.collapsedPaths.add(path);
                    }
                },

                expandAll() { this.collapsedPaths.clear(); },
                collapseAll() {
                    this.treeNodes.forEach(n => {
                        if (n.hasChildren) this.collapsedPaths.add(n.path);
                    });
                },

                handleNodeClick(node) {
                    // 1. If it has children, toggle it (Folder behavior)
                    // if (node.hasChildren) {
                    //     this.toggleNode(node.path);
                    // }
                    // User preference: Click name = Select? Or Click name = Toggle?
                    // Let's do: Click Arrow = Toggle, Click Row = Select (if real group)

                    if (node.isRealGroup) {
                        this.selectedGroup = node.path;
                        this.currentGroupData = node.data;
                        this.refreshData();
                    } else {
                        // If it's just a folder, toggle it
                        this.toggleNode(node.path);
                    }
                },

                // --- Helpers ---

                isGroupHealthy(group) {
                    if (!group || !group.list_url_status) return true; // Assume ok if no anchor
                    const s = group.list_url_status.status;
                    return s !== 3 && s !== 4; // Not Fail
                },

                get anchorStatus() { return this.currentGroupData?.list_url_status; },

                getAnchorColorClass(status) {
                    if (status === 1) return 'bg-blue-500';
                    if (status === 2) return 'bg-emerald-500';
                    if (status === 3 || status === 4) return 'bg-red-500';
                    return 'bg-gray-600';
                },

                async controlSystem(action) {
                    await fetch(`/api/control/${action}`, {method: 'POST'});
                    if(action !== 'IMMEDIATE') this.controlState = (action === 'RESUME' ? 'NORMAL' : 'PAUSE');
                },

                getStatusLabel(s) { return {0:'PEND',1:'RUN',2:'OK',3:'RETRY',4:'FAIL',5:'SKIP'}[s] || s; },
                formatTimeOnly(iso) { return iso ? iso.split('T')[1].split('.')[0] : ''; },

                formatTimeAgo(iso) {
                    if (!iso) return '-';
                    const s = (new Date() - new Date(iso)) / 1000;
                    if (s < 60) return Math.floor(s) + 's ago';
                    if (s < 3600) return Math.floor(s/60) + 'm ago';
                    return Math.floor(s/3600) + 'h ago';
                },
                formatNextRun(iso) {
                    if (!iso) return '-';
                    const diff = (new Date(iso) - new Date()) / 1000;
                    return diff < 0 ? 'Now' : Math.floor(diff) + 's';
                },
                viewSnapshot(log) { alert("Hash required"); }
            }
        }
    </script>
</body>
</html>
