# =========================
#  NGINX (Windows) Main Config
# =========================

worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Windows 上建议开启（减少频繁打开文件句柄）
    sendfile        on;
    keepalive_timeout  65;

    # -------------------------
    # 真实客户端 IP（如果你前面还有一层反向代理）
    # 重要：把下面的 set_real_ip_from 改成“上游代理的出口 IP / 网段”
    # real_ip 模块用于将客户端地址替换为指定 header 中的地址，并要求设置可信来源。[5](https://nginx.org/en/docs/http/ngx_http_realip_module.html)
    # -------------------------
    # set_real_ip_from  1.2.3.4;        # <-- 例：上游代理出口 IP
    # set_real_ip_from  10.0.0.0/8;     # <-- 例：上游代理网段
    # real_ip_header    X-Forwarded-For;
    # real_ip_recursive on;

    # -------------------------
    # 日志格式：GoAccess 友好（在 combined 基础上加 request_time / upstream 信息）
    # Nginx 可以用 log_format 自定义访问日志字段。[6](https://docs.nginx.com/nginx/admin-guide/monitoring/logging/)
    # -------------------------
    log_format goaccess_ext
        '$remote_addr - $remote_user [$time_local] '
        '"$request" $status $body_bytes_sent '
        '"$http_referer" "$http_user_agent" '
        'rt=$request_time '
        'ua="$upstream_addr" us="$upstream_status" urt="$upstream_response_time" '
        'xff="$http_x_forwarded_for" reqid="$request_id"';

    # 全局默认访问日志（主服务）
    access_log  C:/nginx/logs/access_main.log  goaccess_ext;
    error_log   C:/nginx/logs/error.log  warn;

    # 如果你需要更大的 body（例如上传），可调整：
    client_max_body_size 50m;

    # 反代通用头
    proxy_set_header Host              $host;
    proxy_set_header X-Request-ID      $request_id;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;

    # ================
    # 1) HTTP -> HTTPS 重定向
    # ================
    server {
        listen       80;
        server_name  sleepysoft.asuscomm.com;

        # 你对外 HTTPS 在 25000 端口
        # 如果你的“真正域名主机”已把 443 映射到本机 25000，
        # 那么这里可以去掉 :25000，改成 https://$host$request_uri
        return 301 https://$host:25000$request_uri;
    }

    # ================
    # 2) HTTPS 主站（25000）
    # ================
    server {
        listen       25000 ssl;
        server_name  sleepysoft.asuscomm.com;

        ssl_certificate      C:/nginx/conf/ssl/server.crt;
        ssl_certificate_key  C:/nginx/conf/ssl/server.key;

        # TLS 建议（可按你环境调整）
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # -------------------------
        # 主服务：/ -> 127.0.0.1:5000
        # -------------------------
        location / {
            # 可单独记录主服务日志
            access_log C:/nginx/logs/access_main.log goaccess_ext;

            proxy_pass http://127.0.0.1:5000;
            proxy_read_timeout  60s;
            proxy_connect_timeout 5s;
        }

        # -------------------------
        # auth_request 内部认证子请求入口（仅供 Nginx 内部调用）
        # auth_request 基于子请求结果授权：2xx 放行，401/403 拒绝。[1](https://nginx.org/en/docs/http/ngx_http_auth_request_module.html)[2](https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-subrequest-authentication/)
        # 且认证子请求通常不传 body，建议 proxy_pass_request_body off 并清空 Content-Length。[2](https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-subrequest-authentication/)[1](https://nginx.org/en/docs/http/ngx_http_auth_request_module.html)
        # -------------------------
        location = /_auth_check {
            internal;
            access_log C:/nginx/logs/access_auth_check.log goaccess_ext;

            proxy_pass http://127.0.0.1:5000/auth_check;

            proxy_pass_request_body off;
            proxy_set_header Content-Length "";

            # 把原始 URI 给主服务（便于你在 /auth_check 做细粒度授权）
            proxy_set_header X-Original-URI $request_uri;

            # 认证依赖 cookie/session：必须把客户端 Cookie 转给 5000
            proxy_set_header Cookie $http_cookie;
        }

        # 未登录时跳转登录页（带 next 回跳）
        location @login {
            return 302 /login?next=$scheme://$host$request_uri;
        }

        # -------------------------
        # 子服务：/crawl_monitor/ -> 127.0.0.1:8002/
        # - 认证：auth_request -> /_auth_check -> 5000 /auth_check
        # - 路径：通过 proxy_pass 末尾 / 来“剥离前缀”
        #   /crawl_monitor/api/x  =>  http://127.0.0.1:8002/api/x
        # -------------------------
        location /crawl_monitor/ {
            access_log C:/nginx/logs/access_crawl_monitor.log goaccess_ext;

            auth_request /_auth_check;
            error_page 401 = @login;
            error_page 403 = @login;

            # 如果子服务需要知道前缀（生成链接/重定向），可传这个头：
            proxy_set_header X-Forwarded-Prefix /crawl_monitor;

            # 关键：末尾带 /，让 Nginx 去掉 location 前缀再转发
            proxy_pass http://127.0.0.1:8002/;

            proxy_read_timeout  60s;
            proxy_connect_timeout 5s;
        }

        # 便于以后扩展：其它子服务模板（复制一段改 prefix 和端口即可）
        # location /your_prefix/ {
        #     access_log C:/nginx/logs/access_your_prefix.log goaccess_ext;
        #     auth_request /_auth_check;
        #     error_page 401 = @login;
        #     error_page 403 = @login;
        #     proxy_set_header X-Forwarded-Prefix /your_prefix;
        #     proxy_pass http://127.0.0.1:PORT/;
        # }

    } # end server 25000
}
