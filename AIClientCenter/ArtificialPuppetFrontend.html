<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Client Emulator & Chaos Controller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .client-card { transition: all 0.3s; border-left: 5px solid #ccc; }
        .priority-10 { border-left-color: #ffc107; } /* Gold */
        .priority-50 { border-left-color: #adb5bd; } /* Silver */
        .priority-100 { border-left-color: #cd7f32; } /* Bronze */
        .log-box { height: 150px; overflow-y: auto; font-size: 0.8rem; background: #f8f9fa; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
        .bg-available { background-color: #198754; }
        .bg-busy { background-color: #dc3545; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-light">

<div id="app" class="container py-4" v-cloak>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">AI Client Cluster Emulator</h2>
            <p class="text-muted small">Chaos Engineering & Priority Logic Tester</p>
        </div>
        <div>
            <button class="btn btn-outline-primary btn-sm" @click="fetchClients">
                Refresh Now
            </button>
            <div class="form-check form-switch d-inline-block ms-2">
                <input class="form-check-input" type="checkbox" v-model="autoRefresh">
                <label class="form-check-label">Auto Poll</label>
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title">üöÄ Live Test Console</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Simulated User</label>
                    <input type="text" class="form-control" v-model="testUser" placeholder="e.g. user_01">
                    <div class="form-text text-muted">Same user sticks to same client.</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Prompt</label>
                    <input type="text" class="form-control" v-model="testPrompt" placeholder="Type something...">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" @click="sendChat" :disabled="testing">
                        <span v-if="testing" class="spinner-border spinner-border-sm"></span>
                        Send Request
                    </button>
                </div>
            </div>
            <div v-if="lastResult" class="mt-3 p-3 bg-dark text-light rounded font-monospace" style="font-size: 0.85rem;">
                <div><strong>Client Used:</strong> <span class="text-warning">{{ lastResult.client_used }}</span></div>
                <div v-if="lastResult.response.error" class="text-danger">
                    Error: {{ lastResult.response.message }}
                </div>
                <div v-else>
                    Response: {{ lastResult.response.choices[0].message.content }}
                    <span class="text-muted ms-2">(Tokens: {{ lastResult.response.usage.total_tokens }})</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4 col-md-6" v-for="client in clients" :key="client.name">
            <div class="card h-100 shadow-sm client-card" :class="'priority-'+client.priority">
                <div class="card-header d-flex justify-content-between align-items-center bg-white">
                    <strong>{{ client.name }}</strong>
                    <span class="badge rounded-pill"
                          :class="client.in_use ? 'bg-danger' : 'bg-success'">
                        {{ client.in_use ? 'BUSY' : 'IDLE' }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3" style="font-size: 0.9rem;">
                        <div class="col-4 border-end">
                            <div class="fw-bold">{{ client.stats.total_calls }}</div>
                            <div class="text-muted small">Calls</div>
                        </div>
                        <div class="col-4 border-end">
                            <div class="fw-bold text-danger">{{ client.stats.total_errors }}</div>
                            <div class="text-muted small">Errors</div>
                        </div>
                        <div class="col-4">
                            <div class="fw-bold text-success">${{ client.stats.total_cost.toFixed(4) }}</div>
                            <div class="text-muted small">Cost</div>
                        </div>
                    </div>

                    <div class="mb-3 small">
                        <div class="d-flex justify-content-between">
                            <span>Balance:</span>
                            <span>${{ client.config.simulated_balance.toFixed(2) }}</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-info" :style="{width: Math.max(0, client.config.simulated_balance) + '%'}"></div>
                        </div>
                        <div class="mt-1 text-muted" v-if="client.held_by">
                            Held by: <strong>{{ client.held_by }}</strong>
                        </div>
                    </div>

                    <div class="accordion" :id="'acc-'+cleanId(client.name)">
                        <div class="accordion-item border-0">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2 bg-light" type="button" data-bs-toggle="collapse" :data-bs-target="'#collapse-'+cleanId(client.name)">
                                    ‚öôÔ∏è Remote Control
                                </button>
                            </h2>
                            <div :id="'collapse-'+cleanId(client.name)" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                                <div class="accordion-body p-2 bg-light">
                                    <label class="form-label small mb-0">Latency ({{client.config.min_latency_ms}}-{{client.config.max_latency_ms}}ms)</label>
                                    <input type="range" class="form-range" min="0" max="5000" step="100"
                                           v-model.number="client.config.max_latency_ms"
                                           @change="updateClient(client)">

                                    <label class="form-label small mb-0 mt-2">Random Error Rate: {{ (client.config.error_rate * 100).toFixed(0) }}%</label>
                                    <input type="range" class="form-range" min="0" max="1" step="0.1"
                                           v-model.number="client.config.error_rate"
                                           @change="updateClient(client)">

                                    <label class="form-label small mb-0 mt-2">Inject Failure</label>
                                    <select class="form-select form-select-sm" v-model="client.config.forced_error_type" @change="updateClient(client)">
                                        <option value="none">None (Healthy)</option>
                                        <option value="timeout">Force Timeout</option>
                                        <option value="http_500">Force HTTP 500</option>
                                        <option value="http_429">Force Rate Limit</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="text-muted small mb-1">Recent Activity</div>
                        <div class="log-box border rounded p-2">
                            <div v-for="log in client.stats.history_logs" :key="log.id" class="mb-1 border-bottom pb-1">
                                <span class="badge bg-secondary" style="font-size: 0.6rem">{{ log.time }}</span>
                                <span class="badge" :class="log.status==='SUCCESS'?'bg-success':'bg-danger'" style="font-size: 0.6rem">{{ log.status }}</span>
                                <span class="text-muted ms-1">{{ log.latency }}</span>
                            </div>
                            <div v-if="client.stats.history_logs.length === 0" class="text-center text-muted mt-4">No activity</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                clients: [],
                autoRefresh: true,
                timer: null,
                testUser: 'user_default',
                testPrompt: 'Hello AI',
                testing: false,
                lastResult: null
            }
        },
        mounted() {
            this.fetchClients();
            this.timer = setInterval(() => {
                if (this.autoRefresh) this.fetchClients();
            }, 2000); // Poll every 2 seconds
        },
        methods: {
            async fetchClients() {
                try {
                    const res = await fetch('/api/clients');
                    const data = await res.json();
                    // Merge data to prevent UI flickering if possible, but simple replace works for demo
                    // If user is editing a slider, replacing the object might reset focus.
                    // Simplistic approach: Just replace.
                    if (this.clients.length === 0) {
                        this.clients = data;
                    } else {
                        // Update existing objects to keep UI state if possible, or just replace values
                        this.clients = data;
                    }
                } catch (e) {
                    console.error("Poll error", e);
                }
            },
            async updateClient(client) {
                // Send new config to backend
                try {
                    await fetch(`/api/clients/${client.name}/config`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            min_latency_ms: client.config.min_latency_ms / 2, // Simple heuristic logic
                            max_latency_ms: client.config.max_latency_ms,
                            error_rate: client.config.error_rate,
                            forced_error_type: client.config.forced_error_type
                        })
                    });
                } catch (e) {
                    alert("Failed to update config");
                }
            },
            async sendChat() {
                this.testing = true;
                this.lastResult = null;
                try {
                    const res = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            user: this.testUser,
                            prompt: this.testPrompt
                        })
                    });
                    const data = await res.json();
                    this.lastResult = data;
                    this.fetchClients(); // Immediate refresh
                } catch (e) {
                    this.lastResult = { response: { error: true, message: e.message }};
                } finally {
                    this.testing = false;
                }
            },
            cleanId(name) {
                return name.replace(/[^a-zA-Z0-9]/g, '');
            }
        }
    }).mount('#app');
</script>
</body>
</html>
